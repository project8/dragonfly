

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>A Dragonfly powered key-value store &mdash; dripline v3.0.0-4-gd71a66e documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/Blue_Dragonfly-32x32.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="dripline v3.0.0-4-gd71a66e documentation" href="../index.html"/>
        <link rel="up" title="Tutorials" href="tutorials.html"/>
        <link rel="next" title="A Single GPIB Instrument with Prologix" href="prologix.html"/>
        <link rel="prev" title="Tutorials" href="tutorials.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> dripline
          

          
          </a>

          
            
            
              <div class="version">
                v3.0.0-4-gd71a66e
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction and Background Reading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting Started</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">Contribute</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="">A Dragonfly powered key-value store</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#getting-started-from-scratch">Getting Started (from scratch)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#amqp-broker-rabbitmq">AMQP Broker (RabbitMQ)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dragonfly-installation">Dragonfly Installation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#what-s-in-a-config-file">What&#8217;s in a config file?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-it-all">Running it all</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#running-the-monitor">Running the monitor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#starting-the-key-value-service">Starting the Key-Value service</a></li>
<li class="toctree-l4"><a class="reference internal" href="#queries-to-the-service">Queries to the service</a></li>
<li class="toctree-l4"><a class="reference internal" href="#seeing-logger-broadcasts">Seeing logger broadcasts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#timed-logger-broadcasts">Timed logger broadcasts</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="prologix.html">A Single GPIB Instrument with Prologix</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cli_tools.html">Command Line Tools</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apidocs/modules.html">dripline</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">dripline</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="tutorials.html">Tutorials</a> &raquo;</li>
      
    <li>A Dragonfly powered key-value store</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/tutorials/kv_store.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="a-dragonfly-powered-key-value-store">
<h1>A Dragonfly powered key-value store<a class="headerlink" href="#a-dragonfly-powered-key-value-store" title="Permalink to this headline">¶</a></h1>
<p>As an exploration of the dripline protocol and how to use it with the dragonfly
package, let&#8217;s create and work with a simple example. We will create a simple key-value
store, which simply records a set of values, which can be accessed by name.
This is certainly a bit contrived, but it allows us to explore the interactions
common in a dripline-based system without needing a physical instrument. For this
reason, the kv_store is very commonly used in testing newly implemented features.</p>
<p>This tutorial is mostly meant as a quick exploration of the commandline tools
in dragonfly. There will be other tutorials covering specific tasks in more detail including writing new config files or creating new endpoints and providers.</p>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">create a developing extension classes tutorial and link it</p>
</div>
<div class="section" id="getting-started-from-scratch">
<h2>Getting Started (from scratch)<a class="headerlink" href="#getting-started-from-scratch" title="Permalink to this headline">¶</a></h2>
<p>There are two steps here, installing/starting an AMQP server is required if you are
doing local development, independent of a running system. It is certainly possible
to work with an existing server, but for development you are encouraged to work
locally, both to ease debugging and to avoid breaking &#8220;production&#8221; components.</p>
<div class="section" id="amqp-broker-rabbitmq">
<h3>AMQP Broker (RabbitMQ)<a class="headerlink" href="#amqp-broker-rabbitmq" title="Permalink to this headline">¶</a></h3>
<p>For detailed instructions, you should visit <a class="reference external" href="https://www.rabbitmq.com/download.html">the official website</a>
and check the section for your operating system. In the case of debian it is a simple as:</p>
<div class="highlight-sh"><div class="highlight"><pre>sudo apt-get install rabbitmq server
sudo rabbitmq-server start
</pre></div>
</div>
<p>Dragonfly works with a vanilla installation of rabbitmq, though there exists support
for user authentication. Users are required if deploying a system across multiple
computers (ie in any realistic production system). For this example we&#8217;re going to just
work locally and save that for later.</p>
</div>
<div class="section" id="dragonfly-installation">
<h3>Dragonfly Installation<a class="headerlink" href="#dragonfly-installation" title="Permalink to this headline">¶</a></h3>
<p>Each package, dripline and dragonfly, includes a <code class="docutils literal"><span class="pre">README.md</span></code> file which has
simple instructions for installation. You can find more detailed instructions in the
<a class="reference internal" href="../getting_started.html"><em>Getting Started</em></a> section. In each case, there are basically three steps:</p>
<ol class="arabic simple">
<li><strong>Prepare your environment:</strong> Usually this amounts to activating a virtualenvironment, or creating one if needed. Further discussion of why you would do this is beyond the scope of this tutorial, but rest assured that it is a very very good idea.</li>
<li><strong>Install dependencies:</strong> The easiest way to do this is to simply run <code class="docutils literal"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-r</span> <span class="pre">requirements.txt</span></code> (or possible a more specific requirements file, also provided).  In most cases setuptools is also capable of installing dependencies, or you are welcome to install them yourself by hand using pip, easy_install, or whatever other method you like.</li>
<li><strong>Install the package:</strong> Again, this is easily done with <code class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">[install|develop]</span></code>, where you use &#8220;install&#8221; if you just want things to work, or &#8220;develop&#8221; if you plan to be making changes to the code and want to test them without re-installing each time.</li>
</ol>
</div>
</div>
<div class="section" id="what-s-in-a-config-file">
<h2>What&#8217;s in a config file?<a class="headerlink" href="#what-s-in-a-config-file" title="Permalink to this headline">¶</a></h2>
<p>The configuration file for our key-value store is named <code class="docutils literal"><span class="pre">kv_store_tutorial.yaml</span></code> and can
be found in the <code class="docutils literal"><span class="pre">examples/</span></code> directory. In this section we&#8217;ll review the contents of
that file and how one might go about writing one from scratch. Feel free to skip this
section and come back later if you are currently working with a running system and not
interested in new config files yet.</p>
<p>Just to get started, let&#8217;s look at the full configuration file for the key-value store.</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight"><pre><span class="hll"><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my_store</span>
</span><span class="hll"><span class="l-Scalar-Plain">broker</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class="hll"><span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Spimescape</span>
</span><span class="hll"><span class="l-Scalar-Plain">endpoints</span><span class="p-Indicator">:</span>
</span>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my_price_list</span>
    <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kv_store</span>
    <span class="l-Scalar-Plain">endpoints</span><span class="p-Indicator">:</span>
<span class="hll">      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">peaches</span>
</span><span class="hll">        <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kv_store_key</span>
</span><span class="hll">        <span class="l-Scalar-Plain">calibration</span><span class="p-Indicator">:</span> <span class="s">&#39;2*{}&#39;</span>
</span><span class="hll">        <span class="l-Scalar-Plain">initial_value</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0.75</span>
</span><span class="hll">        <span class="l-Scalar-Plain">log_interval</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30</span>
</span><span class="hll">        <span class="l-Scalar-Plain">get_on_set</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
</span><span class="hll">        <span class="l-Scalar-Plain">log_on_set</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
</span>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">chips</span>
        <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kv_store_key</span>
        <span class="l-Scalar-Plain">log_interval</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30</span>
        <span class="l-Scalar-Plain">get_on_set</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
        <span class="l-Scalar-Plain">log_on_set</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
        <span class="l-Scalar-Plain">calibration</span><span class="p-Indicator">:</span> <span class="s">&#39;times3({})&#39;</span>
        <span class="l-Scalar-Plain">initial_value</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1.75</span>
<span class="hll">      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">waffles</span>
</span><span class="hll">        <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kv_store_key</span>
</span><span class="hll">        <span class="l-Scalar-Plain">log_interval</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30</span>
</span><span class="hll">        <span class="l-Scalar-Plain">log_on_set</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
</span><span class="hll">        <span class="l-Scalar-Plain">calibration</span><span class="p-Indicator">:</span> <span class="s">&#39;1.*{}&#39;</span>
</span><span class="hll">        <span class="l-Scalar-Plain">initial_value</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4.00</span>
</span>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">peaches_status</span>
        <span class="l-Scalar-Plain">log_on_set</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
        <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kv_store_key</span>
        <span class="l-Scalar-Plain">initial_value</span><span class="p-Indicator">:</span> <span class="s">&quot;CLOSE&quot;</span>
        <span class="l-Scalar-Plain">calibration</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">CLOSE</span><span class="p-Indicator">:</span> <span class="s">&quot;on&quot;</span>
            <span class="l-Scalar-Plain">OPEN</span><span class="p-Indicator">:</span> <span class="s">&quot;off&quot;</span>
        <span class="l-Scalar-Plain">set_value_map</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">OPEN</span>
            <span class="l-Scalar-Plain">0</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">CLOSE</span>
            <span class="s">&quot;on&quot;</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">OPEN</span>
            <span class="s">&quot;off&quot;</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">CLOSE</span>
        <span class="l-Scalar-Plain">set_value_lowercase</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
</pre></div>
</td></tr></table></div>
<p>The stripped highlighting divides the above config file into blocks, each of which
will be used to create a python object when the service is started. Within each
block there are (currently) four reserved keys [name, module, module_path, endpoints].</p>
<ul class="simple">
<li><strong>name:</strong> is always required and must be a string; it specifies the binding key for whic the object will listen to messages (and should be unique across all services)</li>
<li><strong>module:</strong> is the python class of which the object will be an instance. In the case of the first/top level object, this field is optional and defaults to &#8220;Spimescape&#8221; if missing (this is done for backward compatibility, preferred usage is to always specify).</li>
<li><strong>module_path:</strong> allows the user to provide a class implementation which is not part of dragonfly. The path must be to a python source file which implements the &#8220;module&#8221; named. This is intended to make it easier to test new object implementations, and to allow use of objects which are so case-specific that they don&#8217;t really belong in dragonfly.</li>
<li><strong>endpoints:</strong> should only be present if the &#8220;module&#8221; is a subclass of <code class="docutils literal"><span class="pre">Provider</span></code>. If present, it contains a list of object configurations for objects which should use this instance as their provider.</li>
</ul>
<p>All other elements describe parameters of the instance and are passed to
<code class="docutils literal"><span class="pre">&lt;module&gt;.__init__()</span></code> when the service is creating the instances. Note that
dripline and dragonfly make heavy use of multi-generational inheritance. Each
child class can implement new kwargs to <code class="docutils literal"><span class="pre">__init__</span></code>, but pass all others to
the parent class. Therefore, the config file may contain kwargs for the class
or any of its ancestors. If you want to know what parameters are available,
the easiest (and most likely up-to-date) way is to use the [i]python interpretor
to print the class&#8217;s doc string (note that dragonfly uses introspection to
update the doc string at runtime, so this is generally more complete than the
docstring present in the source). If, for example, you wanted to see what is
available for a <code class="docutils literal"><span class="pre">kv_store_key</span></code> instance, you would use the following two lines</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">dragonfly</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">help</span><span class="p">(</span><span class="n">dragonfly</span><span class="o">.</span><span class="n">implementations</span><span class="o">.</span><span class="n">kv_store_key</span><span class="p">)</span>
</pre></div>
</div>
<p>Which would open your shell&#8217;s pager with output that starts like the following:</p>
<div class="highlight-sh"><div class="highlight"><pre>Help on class kv_store_key in module abc:

class kv_store_key<span class="o">(</span>dragonfly.implementations.kv_store.kv_store_key<span class="o">)</span>
<span class="p">|</span>  A key in the KV store.
<span class="p">|</span>
<span class="p">|</span>  Keyword Args:
<span class="p">|</span>      log_on_set <span class="o">(</span>bool<span class="o">)</span>: flag to <span class="nb">enable </span>logging the new value whenever a new one is <span class="nb">set</span>
<span class="p">|</span>      name <span class="o">(</span>str<span class="o">)</span>: unique identifier across all dripline services <span class="o">(</span>used to determine routing key<span class="o">)</span>
<span class="p">|</span>      calibration <span class="o">(</span>str<span class="o">||</span>dict<span class="o">)</span>: string use to process raw get result <span class="o">(</span>with .format<span class="o">(</span>raw<span class="o">))</span> or a dict to use <span class="k">for</span> the same purpose where raw must be a key
<span class="p">|</span>      get_on_set <span class="o">(</span>bool<span class="o">)</span>: flag to toggle running <span class="s1">&#39;on_get&#39;</span> after each <span class="s1">&#39;on_set&#39;</span>
<span class="p">|</span>      log_interval <span class="o">(</span>float<span class="o">)</span>: minimum <span class="nb">time </span>in seconds between sequential log events <span class="o">(</span>note that this may or may not produce an actual log broadcast<span class="o">)</span>
<span class="p">|</span>      max_interval <span class="o">(</span>float<span class="o">)</span>: If &gt; 0, any log event exceding this number of seconds since the last broadcast will trigger a broadcast.
<span class="p">|</span>      max_fractional_change <span class="o">(</span>float<span class="o">)</span>: If &gt; 0, any log event which produces a value which differs from the previous value by more than this amount <span class="o">(</span>expressed as a fraction, ie 10% change is 0.1<span class="o">)</span> will trigger a broadcast
<span class="p">|</span>      alert_routing_key <span class="o">(</span>str<span class="o">)</span>: routing key <span class="k">for</span> the alert message send when broadcasting a logging event result. The default value of <span class="s1">&#39;sensor_value&#39;</span> is valid <span class="k">for</span> DataLoggers which represent physical quantities being stored to the slow controls database tables
<span class="p">|</span>
</pre></div>
</div>
</div>
<div class="section" id="running-it-all">
<h2>Running it all<a class="headerlink" href="#running-it-all" title="Permalink to this headline">¶</a></h2>
<p>To run and interact with our service, we will make use of various subcommands of
the <code class="docutils literal"><span class="pre">dragonfly</span></code> program. It has a fairly complete commandline help for both
the base command and the various subcommands, all accessible using the <code class="docutils literal"><span class="pre">-h</span></code> flag.</p>
<p>So to get a listing of the available subcommands, we will run <code class="docutils literal"><span class="pre">dragonfly</span> <span class="pre">-h</span></code> and see:</p>
<div class="highlight-sh"><div class="highlight"><pre>usage: dragonfly <span class="o">[</span>-h<span class="o">]</span> <span class="o">{</span>get,set,config,run,cmd,send,monitor,serve,watchdog<span class="o">}</span> ...

optional arguments:
-h, --help            show this <span class="nb">help </span>message and <span class="nb">exit</span>

subcommands:
detailed <span class="nb">help </span>is available <span class="k">for</span> each subcommand

<span class="o">{</span>get,set,config,run,cmd,send,monitor,serve,watchdog<span class="o">}</span>
get                 <span class="k">return</span> the value of an endpoint or a property of an
                    endpoint <span class="k">if</span> specified
<span class="nb">set                 set </span>the value of an endpoint, or a property of an
                    endpoint <span class="k">if</span> specified
config              &lt;deprecated&gt; query or <span class="nb">set </span>the value of a property of
                    an endpoint
run                 send an OP_RUN, further details are endpoint specific
cmd                 have an endpoint execute an internal <span class="k">function</span>
send                have an endpoint <span class="o">(</span>which is probably also a provider<span class="o">)</span>
                    execute a send
monitor             utility <span class="k">for</span> listening in on AMQP messages <span class="o">(</span>does not
                    prevent delivery but may prevent undeliverable errors
                    <span class="k">if</span> there is no other valid target<span class="o">)</span>
serve               start a long-running dripline service based on a
                    provided config file <span class="o">(</span>formerly open_spimescape_portal<span class="o">)</span>
watchdog            utility <span class="k">for</span> making sure some data is always showing up
</pre></div>
</div>
<div class="section" id="running-the-monitor">
<h3>Running the monitor<a class="headerlink" href="#running-the-monitor" title="Permalink to this headline">¶</a></h3>
<p>To start, we will use the monitor. It binds to the AMQP exchange with a configurable
binding key, and prints all messages received. This is especially useful when debugging
to see if messages are being sent or to check intermediate steps. We can
review the usage and options with <code class="docutils literal"><span class="pre">dragonfly</span> <span class="pre">monitor</span> <span class="pre">-h</span></code>:</p>
<div class="highlight-sh"><div class="highlight"><pre>usage: dragonfly monitor <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>-v<span class="o">]</span> <span class="o">[</span>-V<span class="o">]</span> <span class="o">[</span>-b <span class="o">[</span>BROKER<span class="o">]]</span> <span class="o">[</span>-c CONFIG<span class="o">]</span> <span class="o">[</span>-t <span class="o">[</span>TMUX<span class="o">]]</span>
                         <span class="o">[</span>--no-slack<span class="o">]</span> <span class="o">[</span>-e exchange name<span class="o">]</span>
                         <span class="o">[</span>-k <span class="o">[</span>keys <span class="o">[</span>keys ...<span class="o">]]]</span> <span class="o">[</span>-po<span class="o">]</span>

optional arguments:
  -h, --help            show this <span class="nb">help </span>message and <span class="nb">exit</span>
  -v, --verbose         increases terminal output verbosity
  -V, --version         display dripline version
  -b <span class="o">[</span>BROKER<span class="o">]</span>, --broker <span class="o">[</span>BROKER<span class="o">]</span>
                        network path <span class="k">for</span> the AMQP broker, <span class="k">if</span> not provided <span class="o">(</span>and
                        <span class="k">if</span> a config file is provided<span class="o">)</span> use the value from the
                        config file<span class="p">;</span> <span class="k">if</span> the option is present with no argument
                        <span class="k">then</span> <span class="s2">&quot;localhost&quot;</span> is used
  -c CONFIG, --config CONFIG
                        path <span class="o">(</span>absolute or relative<span class="o">)</span> to configuration file
  -t <span class="o">[</span>TMUX<span class="o">]</span>, --tmux <span class="o">[</span>TMUX<span class="o">]</span>
                        <span class="nb">enable </span>running in, and optionally naming, a tmux
                        session
  --no-slack            disable the status log handler to post critical
                        messages to slack
  -e exchange name, --exchange exchange name
                        amqp name of the exchange to monitor
  -k <span class="o">[</span>keys <span class="o">[</span>keys ...<span class="o">]]</span>, --keys <span class="o">[</span>keys <span class="o">[</span>keys ...<span class="o">]]</span>
                        amqp binding keys to follow
  -po, --payload-only   Print only the message.payload
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">-po</span></code> flag is interesting, is displays a much less verbose version of all messages,
so we will use that for now, along with <code class="docutils literal"><span class="pre">-e</span></code> to specify the &#8220;requests&#8221; exchange. By
default the &#8220;alerts&#8221; exchange is used. We do not need to specify a key with <code class="docutils literal"><span class="pre">-k</span></code>
because the default is the all keys wildcard.</p>
<p>Open up either a new terminal or tmux pane (and activate your virtual environment in it)
and then run <code class="docutils literal"><span class="pre">dragonfly</span> <span class="pre">monitor</span> <span class="pre">-e</span> <span class="pre">requests</span> <span class="pre">-v</span></code>. This is a forground process so we
will see a few initial messages as it starts up, then it will sit blocking the terminal
while waiting for new messages to be printed (the <code class="docutils literal"><span class="pre">-v</span></code> may be omitted, but the
less will be printed and it can sometimes be hard to tell if it is running).</p>
</div>
<div class="section" id="starting-the-key-value-service">
<h3>Starting the Key-Value service<a class="headerlink" href="#starting-the-key-value-service" title="Permalink to this headline">¶</a></h3>
<p>Next, we will start our key-value store service, first reminding ourselves of the
command usage:</p>
<div class="highlight-sh"><div class="highlight"><pre>usage: dragonfly serve <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>-v<span class="o">]</span> <span class="o">[</span>-V<span class="o">]</span> <span class="o">[</span>-b <span class="o">[</span>BROKER<span class="o">]]</span> <span class="o">[</span>-c CONFIG<span class="o">]</span> <span class="o">[</span>-t <span class="o">[</span>TMUX<span class="o">]]</span>
                       <span class="o">[</span>--no-slack<span class="o">]</span> <span class="o">[</span>-k BINDING_KEYS<span class="o">]</span>

optional arguments:
  -h, --help            show this <span class="nb">help </span>message and <span class="nb">exit</span>
  -v, --verbose         increases terminal output verbosity
  -V, --version         display dripline version
  -b <span class="o">[</span>BROKER<span class="o">]</span>, --broker <span class="o">[</span>BROKER<span class="o">]</span>
                        network path <span class="k">for</span> the AMQP broker, <span class="k">if</span> not provided <span class="o">(</span>and
                        <span class="k">if</span> a config file is provided<span class="o">)</span> use the value from the
                        config file<span class="p">;</span> <span class="k">if</span> the option is present with no argument
                        <span class="k">then</span> <span class="s2">&quot;localhost&quot;</span> is used
  -c CONFIG, --config CONFIG
                        path <span class="o">(</span>absolute or relative<span class="o">)</span> to configuration file
  -t <span class="o">[</span>TMUX<span class="o">]</span>, --tmux <span class="o">[</span>TMUX<span class="o">]</span>
                        <span class="nb">enable </span>running in, and optionally naming, a tmux
                        session
  --no-slack            disable the status log handler to post critical
                        messages to slack
  -k BINDING_KEYS, --keys BINDING_KEYS
                        amqp binding keys to match against
</pre></div>
</div>
<p>So moving to another terminal or tmux pane (again with our virtual environment active),
we start the service with <code class="docutils literal"><span class="pre">dragonfly</span> <span class="pre">serve</span> <span class="pre">-c</span> <span class="pre">examples/kv_store_tutorial.yaml</span> <span class="pre">-v</span></code>.
Again, we will see some messages as it starts up, and can omit <code class="docutils literal"><span class="pre">-v</span></code> to silence output
or add <code class="docutils literal"><span class="pre">-vv</span></code> to have extremely verbose output of what our service is doing.</p>
</div>
<div class="section" id="queries-to-the-service">
<h3>Queries to the service<a class="headerlink" href="#queries-to-the-service" title="Permalink to this headline">¶</a></h3>
<p>Great, so now we have a running dripline service, started with dragonfly. What if
we want to see the current value of the &#8220;peaches&#8221; endpoint? We use the &#8220;get&#8221; subcommand.
You should know how to check the syntax by now, the answer is <code class="docutils literal"><span class="pre">dragonfly</span> <span class="pre">get</span> <span class="pre">peaches</span></code>
and should return something that looks like the following:</p>
<div class="highlight-sh"><div class="highlight"><pre>peaches<span class="o">(</span>ret:0<span class="o">)</span>: <span class="o">{</span>u<span class="s1">&#39;value_cal&#39;</span>: 1.5, u<span class="s1">&#39;value_raw&#39;</span>: u<span class="s1">&#39;0.75&#39;</span><span class="o">}</span>
</pre></div>
</div>
<p>So we see the raw and calibrated values. The monitor should display something like the following
two messages. The first is our &#8220;get&#8221; request, and the second is the reply sent back to it.
In the case of the key-value store, the expectation is two similar messages for any request
we may send. In more complicated instrument interactions there could be several because
one endpoint may need to make its own requests to other endpoints in order to properly respond.</p>
<div class="highlight-sh"><div class="highlight"><pre>2015-12-04T17:25:03<span class="o">[</span>Level 35<span class="o">]</span> dragonfly.subcommands.message_monitor<span class="o">(</span>34<span class="o">)</span> -&gt;
dripline.core.Service <span class="o">[</span>peaches<span class="o">]</span>     <span class="o">(</span>From App <span class="o">[</span>routing_key<span class="o">])</span>
<span class="o">{</span>
    <span class="s2">&quot;timestamp&quot;</span>: <span class="s2">&quot;2015-12-05T01:25:03Z&quot;</span>,
    <span class="s2">&quot;sender_info&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;username&quot;</span>: <span class="s2">&quot;laroque&quot;</span>,
        <span class="s2">&quot;exe&quot;</span>: <span class="s2">&quot;/home/laroque/python_environments/more_alerts/bin/dragonfly&quot;</span>,
        <span class="s2">&quot;package&quot;</span>: <span class="s2">&quot;dripline&quot;</span>,
        <span class="s2">&quot;hostname&quot;</span>: <span class="s2">&quot;higgsino&quot;</span>,
        <span class="s2">&quot;version&quot;</span>: <span class="s2">&quot;wp1.4.0&quot;</span>,
        <span class="s2">&quot;commit&quot;</span>: <span class="s2">&quot;g5c3ea72&quot;</span>
    <span class="o">}</span>,
    <span class="s2">&quot;payload&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;values&quot;</span>: <span class="o">[]</span>
    <span class="o">}</span>,
    <span class="s2">&quot;msgop&quot;</span>: 1
<span class="o">}</span>
2015-12-04T17:25:03<span class="o">[</span>Level 35<span class="o">]</span> dragonfly.subcommands.message_monitor<span class="o">(</span>34<span class="o">)</span> -&gt;
dripline.core.Service <span class="o">[</span>request_reply582034c6-ebbf-4379-9dc9-6a0b159b7527<span class="o">]</span>     <span class="o">(</span>From App <span class="o">[</span>routing_key<span class="o">])</span>
<span class="o">{</span>
    <span class="s2">&quot;timestamp&quot;</span>: <span class="s2">&quot;2015-12-05T01:25:03Z&quot;</span>,
    <span class="s2">&quot;sender_info&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;username&quot;</span>: <span class="s2">&quot;laroque&quot;</span>,
        <span class="s2">&quot;exe&quot;</span>: <span class="s2">&quot;/home/laroque/python_environments/more_alerts/bin/dragonfly&quot;</span>,
        <span class="s2">&quot;package&quot;</span>: <span class="s2">&quot;dripline&quot;</span>,
        <span class="s2">&quot;hostname&quot;</span>: <span class="s2">&quot;higgsino&quot;</span>,
        <span class="s2">&quot;version&quot;</span>: <span class="s2">&quot;wp1.4.0&quot;</span>,
        <span class="s2">&quot;commit&quot;</span>: <span class="s2">&quot;g5c3ea72&quot;</span>
    <span class="o">}</span>,
    <span class="s2">&quot;retcode&quot;</span>: 0,
    <span class="s2">&quot;return_msg&quot;</span>: <span class="s2">&quot;&quot;</span>,
    <span class="s2">&quot;payload&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;value_cal&quot;</span>: 1.5,
        <span class="s2">&quot;value_raw&quot;</span>: <span class="s2">&quot;0.75&quot;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="seeing-logger-broadcasts">
<h3>Seeing logger broadcasts<a class="headerlink" href="#seeing-logger-broadcasts" title="Permalink to this headline">¶</a></h3>
<p>Now that we have seen the basic request/reply messages in the monitor, we can turn it off,
and instead run it bound to the alerts exchange. This is where services broadcast individual
messages which are not part of a request/reply pair. The syntax is similar, but the default
&#8220;alerts&#8221; exchange is what we want, and the <code class="docutils literal"><span class="pre">-po</span></code> option is probably desirable
(<code class="docutils literal"><span class="pre">dragonfly</span> <span class="pre">monitor</span> <span class="pre">--po</span></code>). This will allow us to see any values that our endpoints may broadcast.</p>
<p>For a start, we can change the value of peaches, maybe <code class="docutils literal"><span class="pre">dragonfly</span> <span class="pre">set</span> <span class="pre">peaches</span> <span class="pre">0.64</span></code>
for a new value. Notice that in the monitor we see the following:</p>
<div class="highlight-json"><div class="highlight"><pre>2015-12-06T09:18:08[Level 35] dragonfly.subcommands.message_monitor(34) -&gt;
dripline.core.Service [sensor_value.peaches]     (From App [routing_key])
{
  &quot;value_cal&quot;: 1.24,
  &quot;value_raw&quot;: &quot;0.62&quot;
}
</pre></div>
</div>
<p>If we look back to line 14 of the config file, we see that peaches are configured with &#8220;log_on_set&#8221;
set to True. This is interesting; it means that whenever the value of peaches gets changed
the endpoint will broadcast the new value (useful, for example, if another service is listening
for those broadcasts and storing the endpoint values into a database).</p>
</div>
<div class="section" id="timed-logger-broadcasts">
<h3>Timed logger broadcasts<a class="headerlink" href="#timed-logger-broadcasts" title="Permalink to this headline">¶</a></h3>
<p>If our peaches endpoint were not just a store, but represented a measurement (such as a temperature
sensor for example), then we would not have a &#8220;set&#8221; to trigger logs when there are new values.
To deal with this, we can have the log on a timed schedule. By default, when you start a service
the timed loggers are not started. This is done because one often needs to confirm or alter
some configurations before the loggers should actually start broadcasting.</p>
<p>We can use the &#8220;set&#8221; subcommand to configure a property of an endpoint, in addition to the
vaule of the endpoint itself. That syntax is <code class="docutils literal"><span class="pre">dragonfly</span> <span class="pre">set</span> <span class="pre">peaches.logging_status</span> <span class="pre">on</span></code>
(note the &#8216;.&#8217; delimiter which allows us to specify a property name, and that we provide a value.</p>
<p>You should now see a new value broadcast printed in the message monitor every 30 seconds.
Those should all look the same, since the peaches value is just whatever value is stored,
but you can use <code class="docutils literal"><span class="pre">dragonfly</span> <span class="pre">set</span> <span class="pre">peaches</span> <span class="pre">0.45</span></code> (or any other value) and see that the value
being broadcast changes.</p>
<p>As a convenience, because a single provider often has many endpoints which are loggers,
all of the endpoints associated with a provider may have their &#8220;logging_status&#8221; configured at
once, by sending the &#8220;set&#8221; command to the provider instead (<code class="docutils literal"><span class="pre">dragonfly</span> <span class="pre">set</span> <span class="pre">my_price_list.logging_status</span> <span class="pre">on</span></code>).</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="prologix.html" class="btn btn-neutral float-right" title="A Single GPIB Instrument with Prologix" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tutorials.html" class="btn btn-neutral" title="Tutorials" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, The Project 8 Collaboration.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'v3.0.0-4-gd71a66e',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>